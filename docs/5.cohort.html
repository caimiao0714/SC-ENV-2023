<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>环境暴露的人群健康效应的研究、写作与发表 - 队列研究</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">队列研究</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">环境暴露的人群健康效应的研究、写作与发表</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">引言</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">第一天</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0.intro.html" class="sidebar-item-text sidebar-link">环境健康领域简介</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1.exposure.html" class="sidebar-item-text sidebar-link">环境暴露评估</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">第二天</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2.ts.html" class="sidebar-item-text sidebar-link">时间序列研究</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3.cco.html" class="sidebar-item-text sidebar-link">时间分层的病例交叉研究</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">第三天</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4.cross-sec.html" class="sidebar-item-text sidebar-link">横截面研究</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5.cohort.html" class="sidebar-item-text sidebar-link active">队列研究</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">第四天</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6.writing.html" class="sidebar-item-text sidebar-link">10+文章的写作套路</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./7.journal.html" class="sidebar-item-text sidebar-link">选刊与投稿</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">内容</h2>
   
  <ul>
  <li><a href="#文献实例" id="toc-文献实例" class="nav-link active" data-scroll-target="#文献实例">文献实例</a></li>
  <li><a href="#r语言代码实战" id="toc-r语言代码实战" class="nav-link" data-scroll-target="#r语言代码实战">R语言代码实战</a>
  <ul class="collapse">
  <li><a href="#cox回归" id="toc-cox回归" class="nav-link" data-scroll-target="#cox回归">Cox回归</a>
  <ul class="collapse">
  <li><a href="#读取数据" id="toc-读取数据" class="nav-link" data-scroll-target="#读取数据">读取数据</a></li>
  <li><a href="#拟合模型" id="toc-拟合模型" class="nav-link" data-scroll-target="#拟合模型">拟合模型</a></li>
  <li><a href="#暴露反应关系" id="toc-暴露反应关系" class="nav-link" data-scroll-target="#暴露反应关系">暴露反应关系</a></li>
  <li><a href="#多个图形进行拼图" id="toc-多个图形进行拼图" class="nav-link" data-scroll-target="#多个图形进行拼图">多个图形进行拼图</a></li>
  <li><a href="#限制性立方样条" id="toc-限制性立方样条" class="nav-link" data-scroll-target="#限制性立方样条">限制性立方样条</a></li>
  </ul></li>
  <li><a href="#混合线性模型" id="toc-混合线性模型" class="nav-link" data-scroll-target="#混合线性模型">混合线性模型</a>
  <ul class="collapse">
  <li><a href="#读取数据-1" id="toc-读取数据-1" class="nav-link" data-scroll-target="#读取数据-1">读取数据</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">队列研究</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="文献实例" class="level1">
<h1>文献实例</h1>
<ul>
<li><p>Di, Q., Wang, Y., Zanobetti, A., Wang, Y., Koutrakis, P., Choirat, C., … Schwartz, J. D. (2017). Air pollution and mortality in the Medicare population. <strong><em>New England Journal of Medicine</em></strong> (<span style="color:#9A0000;font-weight: bold;">IF=176</span>), 376(26), 2513-2522. <a href="https://caimiao0714.github.io/SC-ENV-2023/Papers/Di_2017_NEJM.pdf">PDF <i class="fa-solid fa-book-open" aria-label="book-open"></i></a> DOI: <a href="https://doi.org/10.1056/NEJMoa1702747">10.1056/NEJMoa1702747</a></p></li>
<li><p>Yu, K., Qiu, G., Chan, K. H., Lam, K. B. H., Kurmi, O. P., Bennett, D. A., … Wu, T. (2018). Association of solid fuel use with risk of cardiovascular and all-cause mortality in rural China. <strong><em>JAMA</em></strong> (<span style="color:#9A0000;font-weight: bold;">IF=157</span>), 319(13), 1351-1361. <a href="https://caimiao0714.github.io/SC-ENV-2023/Papers/Yu_2018_JAMA_solid_fuel_use.pdf">PDF <i class="fa-solid fa-book-open" aria-label="book-open"></i></a> DOI: <a href="10.1001/jama.2018.2151">https://doi.org/10.1001/jama.2018.2151</a></p></li>
<li><p><strong>Cai, M.</strong>, Li, H., Wu, Y., Zhang. S., Wang. X., Zhang. Z., Lin. H. (2022) Ambient Air Pollution Associated with Body Fat Percentages at Different Body Compartments: A Cohort Study of UK Biobank Participants. <strong><em>Environmental Health Perspectives</em></strong> (<span style="color:#9A0000;font-weight: bold;">IF=11.0</span>). 130(6): 067702. <a href="https://caimiao0714.github.io/SC-ENV-2023/Papers/2022_1_EHP10920_PM_body_fat_composition.pdf">PDF <i class="fa-solid fa-book-open" aria-label="book-open"></i></a></p></li>
<li><p><strong>Cai, M.</strong>, Lin, X., Wang, X., Zhang, S., Qian, Z., McMillin, S.E., Aaron, H.E., Lin, H., Wei, J., Zhang, Z., Pan, J. (2022) Ambient particulate matter pollution of different sizes associated with recurrent stroke hospitalization in China: a cohort study of 1.07 million stroke patients. <strong><em>Science of the Total Environment</em></strong> (<span style="color:#9A0000;font-weight: bold;">IF=10.8</span>). 159104. <a href="https://caimiao0714.github.io/SC-ENV-2023/Papers/2022_1_STOTEN_PM_stroke_rehospitalization.pdf">PDF <i class="fa-solid fa-book-open" aria-label="book-open"></i></a></p></li>
</ul>
</section>
<section id="r语言代码实战" class="level1">
<h1>R语言代码实战</h1>
<section id="cox回归" class="level2">
<h2 class="anchored" data-anchor-id="cox回归">Cox回归</h2>
<div class="cell">

</div>
<section id="读取数据" class="level3">
<h3 class="anchored" data-anchor-id="读取数据">读取数据</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2"></a>  arrow, dplyr, ggplot2, data.table, broom, survival, splines, survival, purrr, latex2exp, patchwork, rms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>also installing the dependencies 'Formula', 'mvtnorm', 'TH.data', 'sandwich', 'checkmate', 'webshot', 'svglite', 'Hmisc', 'polspline', 'multcomp', 'htmlTable', 'kableExtra'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: unable to access index for repository http://www.stats.ox.ac.uk/pub/RWin/bin/windows/contrib/4.2:
  cannot open URL 'http://www.stats.ox.ac.uk/pub/RWin/bin/windows/contrib/4.2/PACKAGES'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>package 'Formula' successfully unpacked and MD5 sums checked
package 'mvtnorm' successfully unpacked and MD5 sums checked
package 'TH.data' successfully unpacked and MD5 sums checked
package 'sandwich' successfully unpacked and MD5 sums checked
package 'checkmate' successfully unpacked and MD5 sums checked
package 'webshot' successfully unpacked and MD5 sums checked
package 'svglite' successfully unpacked and MD5 sums checked
package 'Hmisc' successfully unpacked and MD5 sums checked
package 'polspline' successfully unpacked and MD5 sums checked
package 'multcomp' successfully unpacked and MD5 sums checked
package 'htmlTable' successfully unpacked and MD5 sums checked
package 'kableExtra' successfully unpacked and MD5 sums checked
package 'rms' successfully unpacked and MD5 sums checked

The downloaded binary packages are in
    C:\Users\miaoc\AppData\Local\Temp\Rtmpc1tzv9\downloaded_packages</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
rms installed</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'rms' was built under R version 4.2.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Hmisc' was built under R version 4.2.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>cohort_cox <span class="ot">=</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(</span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="st">'Data/cohort_Cox_synthetic.parquet'</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="fu">glimpse</span>(cohort_cox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 8,262
Columns: 12
$ rehosp_staus      &lt;dbl&gt; 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0…
$ t2rehosp          &lt;int&gt; 741, 1267, 510, 126, 1076, 402, 980, 589, 502, 524, …
$ age               &lt;dbl&gt; 74, 79, 72, 79, 52, 75, 68, 62, 75, 73, 77, 70, 76, …
$ sex               &lt;fct&gt; Female, Female, Female, Female, Female, Female, Fema…
$ ethnicity         &lt;fct&gt; Han, Han, Han, Han, Han, Han, Han, Han, Han, Han, Ha…
$ marriage          &lt;fct&gt; Married, Married, Married, Married, Married, Married…
$ occupation        &lt;fct&gt; Farmer, Farmer, Other, Other, Other, Farmer, Other, …
$ PM1_MA_365        &lt;dbl&gt; 26.94837, 21.58845, 26.15891, 25.80991, 34.91308, 36…
$ PM2.5_MA_365      &lt;dbl&gt; 41.79592, 31.49986, 36.12802, 42.01941, 48.28277, 44…
$ PM10_MA_365       &lt;dbl&gt; 68.51770, 63.77828, 57.15183, 67.48609, 76.22407, 72…
$ Temperature_MA_07 &lt;dbl&gt; 5.847840, 24.166486, 26.243227, 9.688386, 6.529096, …
$ RH_MA_07          &lt;dbl&gt; 73.08185, 67.75124, 87.87124, 72.36949, 68.59028, 71…</code></pre>
</div>
</div>
</section>
<section id="拟合模型" class="level3">
<h3 class="anchored" data-anchor-id="拟合模型">拟合模型</h3>
<div class="cell" data-hash="5.cohort_cache/html/unnamed-chunk-3_ce2231f3f485423e3d2391cfe118d9c5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>fit0 <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(t2rehosp, rehosp_staus) <span class="sc">~</span> PM1_MA_365 <span class="sc">+</span> age <span class="sc">+</span> ethnicity <span class="sc">+</span> </span>
<span id="cb10-3"><a href="#cb10-3"></a>      marriage <span class="sc">+</span> occupation <span class="sc">+</span> <span class="fu">ns</span>(Temperature_MA_07, <span class="at">df =</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fu">ns</span>(RH_MA_07, <span class="at">df =</span> <span class="dv">5</span>), </span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="at">data =</span> cohort_cox)</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="fu">class</span>(fit0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "coxph"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>fit0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(t2rehosp, rehosp_staus) ~ PM1_MA_365 + age + 
    ethnicity + marriage + occupation + ns(Temperature_MA_07, 
    df = 5) + ns(RH_MA_07, df = 5), data = cohort_cox)

                                    coef exp(coef)  se(coef)      z       p
PM1_MA_365                      0.011054  1.011115  0.003903  2.832 0.00462
age                            -0.001324  0.998677  0.002192 -0.604 0.54576
ethnicityNon-han               -0.058235  0.943428  0.201408 -0.289 0.77247
marriageUnmarried               0.186563  1.205100  0.104045  1.793 0.07296
marriageWidowed                 0.038527  1.039279  0.096506  0.399 0.68973
marriageDivorced                0.207441  1.230525  0.159879  1.297 0.19446
marriageOther                  -0.118606  0.888158  0.158128 -0.750 0.45322
occupationPrivate institution  -0.134948  0.873761  0.151888 -0.888 0.37429
occupationFarmer               -0.101090  0.903852  0.128781 -0.785 0.43247
occupationJobless              -0.149602  0.861050  0.177534 -0.843 0.39942
occupationRetired              -0.101371  0.903598  0.143299 -0.707 0.47931
occupationOther                -0.241753  0.785250  0.131212 -1.842 0.06541
ns(Temperature_MA_07, df = 5)1  0.010090  1.010141  0.762198  0.013 0.98944
ns(Temperature_MA_07, df = 5)2  0.036154  1.036816  0.810714  0.045 0.96443
ns(Temperature_MA_07, df = 5)3 -0.044010  0.956944  0.474768 -0.093 0.92614
ns(Temperature_MA_07, df = 5)4  0.292356  1.339580  1.608833  0.182 0.85580
ns(Temperature_MA_07, df = 5)5 -0.025618  0.974708  0.371333 -0.069 0.94500
ns(RH_MA_07, df = 5)1           0.419264  1.520842  0.664890  0.631 0.52832
ns(RH_MA_07, df = 5)2           0.450642  1.569319  0.691113  0.652 0.51437
ns(RH_MA_07, df = 5)3           0.077616  1.080708  0.392458  0.198 0.84323
ns(RH_MA_07, df = 5)4           0.620296  1.859479  1.408819  0.440 0.65972
ns(RH_MA_07, df = 5)5           0.194996  1.215307  0.419406  0.465 0.64198

Likelihood ratio test=34.99  on 22 df, p=0.03881
n= 8262, number of events= 2474 </code></pre>
</div>
</div>
<div class="cell" data-hash="5.cohort_cache/html/unnamed-chunk-4_e62f5235e8e0a04d7e858af7d7441f07">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># 提取结果成数据框，方便导出excel</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>fit0 <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">tidy</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 5
   term                          estimate std.error statistic p.value
   &lt;chr&gt;                            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
 1 PM1_MA_365                     0.0111    0.00390     2.83  0.00462
 2 age                           -0.00132   0.00219    -0.604 0.546  
 3 ethnicityNon-han              -0.0582    0.201      -0.289 0.772  
 4 marriageUnmarried              0.187     0.104       1.79  0.0730 
 5 marriageWidowed                0.0385    0.0965      0.399 0.690  
 6 marriageDivorced               0.207     0.160       1.30  0.194  
 7 marriageOther                 -0.119     0.158      -0.750 0.453  
 8 occupationPrivate institution -0.135     0.152      -0.888 0.374  
 9 occupationFarmer              -0.101     0.129      -0.785 0.432  
10 occupationJobless             -0.150     0.178      -0.843 0.399  
# ℹ 12 more rows</code></pre>
</div>
</div>
<div class="cell" data-hash="5.cohort_cache/html/unnamed-chunk-5_24e3eda0b0cf8103d705e3a3e73d9e59">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># 提取结果为exp后的HR值，而非线性项的值</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>fit0 <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 5
   term                          estimate std.error statistic p.value
   &lt;chr&gt;                            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
 1 PM1_MA_365                       1.01    0.00390     2.83  0.00462
 2 age                              0.999   0.00219    -0.604 0.546  
 3 ethnicityNon-han                 0.943   0.201      -0.289 0.772  
 4 marriageUnmarried                1.21    0.104       1.79  0.0730 
 5 marriageWidowed                  1.04    0.0965      0.399 0.690  
 6 marriageDivorced                 1.23    0.160       1.30  0.194  
 7 marriageOther                    0.888   0.158      -0.750 0.453  
 8 occupationPrivate institution    0.874   0.152      -0.888 0.374  
 9 occupationFarmer                 0.904   0.129      -0.785 0.432  
10 occupationJobless                0.861   0.178      -0.843 0.399  
# ℹ 12 more rows</code></pre>
</div>
</div>
<div class="cell" data-hash="5.cohort_cache/html/unnamed-chunk-6_153f2cfd24808edc59624dea846cfa83">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># 提取结果为exp后的HR值，而非线性项的值</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>fit0 <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> T, <span class="at">conf.level =</span> <span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 7
   term                  estimate std.error statistic p.value conf.low conf.high
   &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 PM1_MA_365               1.01    0.00390     2.83  0.00462    1.00       1.02
 2 age                      0.999   0.00219    -0.604 0.546      0.994      1.00
 3 ethnicityNon-han         0.943   0.201      -0.289 0.772      0.636      1.40
 4 marriageUnmarried        1.21    0.104       1.79  0.0730     0.983      1.48
 5 marriageWidowed          1.04    0.0965      0.399 0.690      0.860      1.26
 6 marriageDivorced         1.23    0.160       1.30  0.194      0.900      1.68
 7 marriageOther            0.888   0.158      -0.750 0.453      0.651      1.21
 8 occupationPrivate in…    0.874   0.152      -0.888 0.374      0.649      1.18
 9 occupationFarmer         0.904   0.129      -0.785 0.432      0.702      1.16
10 occupationJobless        0.861   0.178      -0.843 0.399      0.608      1.22
# ℹ 12 more rows</code></pre>
</div>
</div>
<div class="cell" data-hash="5.cohort_cache/html/unnamed-chunk-7_ef68da21654554f2120860e8f539b62b">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>fit_cox <span class="ot">=</span> <span class="cf">function</span>(x, <span class="at">dat =</span> drehosp, <span class="at">scale_num =</span> <span class="dv">10</span>){</span>
<span id="cb20-2"><a href="#cb20-2"></a>  clean_fit <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb20-3"><a href="#cb20-3"></a>    <span class="at">formula =</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">"Surv(t2rehosp, rehosp_staus) ~ "</span>, </span>
<span id="cb20-4"><a href="#cb20-4"></a>                    x, </span>
<span id="cb20-5"><a href="#cb20-5"></a>                    <span class="st">' + age + ethnicity + marriage + occupation + </span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="st">                    ns(Temperature_MA_07, df = 5) + ns(RH_MA_07, df = 5)'</span>)), </span>
<span id="cb20-7"><a href="#cb20-7"></a>    <span class="at">data =</span> dat) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="#cb20-8"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-9"><a href="#cb20-9"></a>    <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">'PM|O3|CO|NO2|SO2'</span>, term)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-10"><a href="#cb20-10"></a>    <span class="fu">mutate</span>(<span class="at">OR =</span> <span class="fu">exp</span>(estimate<span class="sc">*</span>scale_num), <span class="dv">3</span>,</span>
<span id="cb20-11"><a href="#cb20-11"></a>           <span class="at">OR_round =</span> <span class="fu">round</span>(<span class="fu">exp</span>(estimate<span class="sc">*</span>scale_num), <span class="dv">3</span>),</span>
<span id="cb20-12"><a href="#cb20-12"></a>           <span class="at">CI_low =</span> <span class="fu">exp</span>(estimate<span class="sc">*</span>scale_num <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>std.error<span class="sc">*</span>scale_num),</span>
<span id="cb20-13"><a href="#cb20-13"></a>           <span class="at">CI_high =</span> <span class="fu">exp</span>(estimate<span class="sc">*</span>scale_num <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>std.error<span class="sc">*</span>scale_num),</span>
<span id="cb20-14"><a href="#cb20-14"></a>           <span class="at">CI_low_round =</span> <span class="fu">round</span>(<span class="fu">exp</span>(estimate<span class="sc">*</span>scale_num <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>std.error<span class="sc">*</span>scale_num), <span class="dv">3</span>),</span>
<span id="cb20-15"><a href="#cb20-15"></a>           <span class="at">CI_high_round =</span> <span class="fu">round</span>(<span class="fu">exp</span>(estimate<span class="sc">*</span>scale_num <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>std.error<span class="sc">*</span>scale_num), <span class="dv">3</span>),</span>
<span id="cb20-16"><a href="#cb20-16"></a>           <span class="at">predictor =</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb20-17"><a href="#cb20-17"></a>    <span class="fu">mutate</span>(<span class="at">result =</span> <span class="fu">paste0</span>(<span class="fu">format</span>(OR_round, <span class="at">nsmall =</span> <span class="dv">3</span>), </span>
<span id="cb20-18"><a href="#cb20-18"></a>                           <span class="st">' ('</span>, </span>
<span id="cb20-19"><a href="#cb20-19"></a>                           <span class="fu">format</span>(CI_low_round, <span class="at">nsmall =</span> <span class="dv">3</span>), </span>
<span id="cb20-20"><a href="#cb20-20"></a>                           <span class="st">'-'</span>, </span>
<span id="cb20-21"><a href="#cb20-21"></a>                           <span class="fu">format</span>(CI_high_round, <span class="at">nsmall =</span> <span class="dv">3</span>),</span>
<span id="cb20-22"><a href="#cb20-22"></a>                           <span class="st">')'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-23"><a href="#cb20-23"></a>    <span class="fu">select</span>(predictor, term, result, OR, CI_low, CI_high, p.value) </span>
<span id="cb20-24"><a href="#cb20-24"></a>  </span>
<span id="cb20-25"><a href="#cb20-25"></a>  <span class="fu">print</span>(x)</span>
<span id="cb20-26"><a href="#cb20-26"></a>  </span>
<span id="cb20-27"><a href="#cb20-27"></a>  <span class="fu">return</span>(clean_fit)</span>
<span id="cb20-28"><a href="#cb20-28"></a>}</span>
<span id="cb20-29"><a href="#cb20-29"></a></span>
<span id="cb20-30"><a href="#cb20-30"></a>estimate_cox <span class="ot">=</span> <span class="fu">map_dfr</span>(</span>
<span id="cb20-31"><a href="#cb20-31"></a>     <span class="fu">c</span>(<span class="st">"PM1_MA_365"</span>, <span class="st">"PM2.5_MA_365"</span>, <span class="st">"PM10_MA_365"</span>), </span>
<span id="cb20-32"><a href="#cb20-32"></a>     fit_cox, </span>
<span id="cb20-33"><a href="#cb20-33"></a>     <span class="at">dat =</span> cohort_cox,</span>
<span id="cb20-34"><a href="#cb20-34"></a>     <span class="at">scale_num =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PM1_MA_365"
[1] "PM2.5_MA_365"
[1] "PM10_MA_365"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>estimate_cox</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
  predictor    term         result                 OR CI_low CI_high     p.value
  &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;               &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;
1 PM1_MA_365   PM1_MA_365   1.117 (1.035-1.206)  1.12   1.03    1.21     4.62e-3
2 PM2.5_MA_365 PM2.5_MA_365 1.112 (1.062-1.165)  1.11   1.06    1.17     7.28e-6
3 PM10_MA_365  PM10_MA_365  1.098 (1.061-1.136)  1.10   1.06    1.14     6.20e-8</code></pre>
</div>
</div>
</section>
<section id="暴露反应关系" class="level3">
<h3 class="anchored" data-anchor-id="暴露反应关系">暴露反应关系</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">quantile</span>(cohort_cox<span class="sc">$</span>PM2<span class="fl">.5</span>_MA_365, <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     25%      50%      75% 
38.12038 42.49512 48.53397 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">quantile</span>(cohort_cox<span class="sc">$</span>PM2<span class="fl">.5</span>_MA_365, <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      1%      99% 
21.55512 67.39910 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>fit_cox_pm2<span class="fl">.5</span> <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="fu">Surv</span>(t2rehosp, rehosp_staus) <span class="sc">~</span> <span class="fu">ns</span>(PM2<span class="fl">.5</span>_MA_365, <span class="at">knots =</span> <span class="fu">c</span>(<span class="fl">40.48</span>, <span class="dv">60</span>, <span class="dv">63</span>)) <span class="sc">+</span> </span>
<span id="cb28-3"><a href="#cb28-3"></a>    age <span class="sc">+</span> ethnicity <span class="sc">+</span> marriage <span class="sc">+</span> occupation <span class="sc">+</span> <span class="fu">ns</span>(Temperature_MA_07, <span class="at">df =</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fu">ns</span>(RH_MA_07, <span class="at">df =</span> <span class="dv">5</span>),</span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="at">data =</span> cohort_cox <span class="sc">%&gt;%</span> </span>
<span id="cb28-5"><a href="#cb28-5"></a>    <span class="fu">filter</span>(PM2<span class="fl">.5</span>_MA_365 <span class="sc">&gt;</span> <span class="fl">21.55</span> <span class="sc">&amp;</span> PM2<span class="fl">.5</span>_MA_365 <span class="sc">&lt;</span> <span class="dv">67</span>)) </span>
<span id="cb28-6"><a href="#cb28-6"></a></span>
<span id="cb28-7"><a href="#cb28-7"></a>sp_cox_pm2<span class="fl">.5</span> <span class="ot">=</span> fit_cox_pm2<span class="fl">.5</span> <span class="sc">%&gt;%</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="fu">termplot</span>(<span class="at">se =</span> T, <span class="at">plot =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb28-9"><a href="#cb28-9"></a>  .[[<span class="st">'PM2.5_MA_365'</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-11"><a href="#cb28-11"></a>  .[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">HR =</span> <span class="fu">exp</span>(y),</span>
<span id="cb28-12"><a href="#cb28-12"></a>          <span class="at">HRmin =</span> <span class="fu">exp</span>(y <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>se),</span>
<span id="cb28-13"><a href="#cb28-13"></a>          <span class="at">HRmax =</span> <span class="fu">exp</span>(y <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>se))] <span class="sc">%&gt;%</span> </span>
<span id="cb28-14"><a href="#cb28-14"></a>  .[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">pollutant =</span> <span class="st">'PM2.5'</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb28-15"><a href="#cb28-15"></a>  .[]</span>
<span id="cb28-16"><a href="#cb28-16"></a></span>
<span id="cb28-17"><a href="#cb28-17"></a>sp_cox_pm2<span class="fl">.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             x          y        se        HR     HRmin     HRmax pollutant
   1: 21.57385 -0.3434542 0.1633379 0.7093160 0.5149958 0.9769578     PM2.5
   2: 21.57581 -0.3434234 0.1633122 0.7093378 0.5150376 0.9769386     PM2.5
   3: 21.60621 -0.3429450 0.1629124 0.7096772 0.5156881 0.9766404     PM2.5
   4: 21.73148 -0.3409740 0.1612655 0.7110774 0.5183760 0.9754136     PM2.5
   5: 21.77162 -0.3403425 0.1607381 0.7115266 0.5192400 0.9750213     PM2.5
  ---                                                                      
8048: 66.53952  0.1896596 0.2733318 1.2088381 0.7074625 2.0655364     PM2.5
8049: 66.64180  0.1940871 0.2833337 1.2142020 0.6968069 2.1157749     PM2.5
8050: 66.73012  0.1979229 0.2920360 1.2188684 0.6876552 2.1604434     PM2.5
8051: 66.93246  0.2067362 0.3121532 1.2296581 0.6669207 2.2672248     PM2.5
8052: 66.95539  0.2077358 0.3144453 1.2308879 0.6645953 2.2797108     PM2.5</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>arr <span class="ot">=</span> <span class="fu">list</span>(<span class="st">'PM1'</span> <span class="ot">=</span> <span class="fu">TeX</span>(<span class="st">"PM$_{1}$"</span>),  </span>
<span id="cb30-2"><a href="#cb30-2"></a>           <span class="st">"PM2.5"</span> <span class="ot">=</span> <span class="fu">TeX</span>(<span class="st">"PM$_{2.5}$"</span>), </span>
<span id="cb30-3"><a href="#cb30-3"></a>           <span class="st">"PM10"</span> <span class="ot">=</span> <span class="fu">TeX</span>(<span class="st">"PM$_{10}$"</span>))</span>
<span id="cb30-4"><a href="#cb30-4"></a>mylabel <span class="ot">=</span> <span class="cf">function</span>(val) { <span class="fu">return</span>(<span class="fu">lapply</span>(val, <span class="cf">function</span>(x) arr[x])) }</span>
<span id="cb30-5"><a href="#cb30-5"></a></span>
<span id="cb30-6"><a href="#cb30-6"></a>color7 <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'#7570b3'</span>, <span class="st">'#d95f02'</span>, <span class="st">'#1b9e77'</span>)</span>
<span id="cb30-7"><a href="#cb30-7"></a></span>
<span id="cb30-8"><a href="#cb30-8"></a>p_cox_pm2<span class="fl">.5</span> <span class="ot">=</span> sp_cox_pm2<span class="fl">.5</span> <span class="sc">%&gt;%</span> </span>
<span id="cb30-9"><a href="#cb30-9"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> HR)) <span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">linetype =</span> <span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> HRmin, <span class="at">ymax =</span> HRmax), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> color7[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb30-12"><a href="#cb30-12"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">color =</span> color7[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb30-13"><a href="#cb30-13"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> pollutant, <span class="at">scales =</span> <span class="st">'free'</span>, <span class="at">labeller =</span> mylabel) <span class="sc">+</span></span>
<span id="cb30-14"><a href="#cb30-14"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb30-15"><a href="#cb30-15"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">'Hazard of death'</span>) <span class="sc">+</span></span>
<span id="cb30-17"><a href="#cb30-17"></a>  <span class="fu">theme_test</span>(<span class="at">base_size =</span> <span class="dv">20</span>, <span class="at">base_family =</span> <span class="st">'serif'</span>) <span class="sc">+</span> <span class="co"># , base_family = 'serif'</span></span>
<span id="cb30-18"><a href="#cb30-18"></a>  <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="fl">0.2</span>), <span class="st">'cm'</span>),</span>
<span id="cb30-19"><a href="#cb30-19"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>, <span class="at">face =</span> <span class="st">'bold'</span>),</span>
<span id="cb30-20"><a href="#cb30-20"></a>        <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">alpha</span>(color7[<span class="dv">1</span>], <span class="fl">0.3</span>), <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb30-21"><a href="#cb30-21"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">'bold'</span>))</span>
<span id="cb30-22"><a href="#cb30-22"></a></span>
<span id="cb30-23"><a href="#cb30-23"></a>p_cox_pm2<span class="fl">.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="5.cohort_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>可以尝试调节不同节点和不同df对曲线的影响。</p>
</section>
<section id="多个图形进行拼图" class="level3">
<h3 class="anchored" data-anchor-id="多个图形进行拼图">多个图形进行拼图</h3>
<p>先拟合一个PM<span class="math inline">\(_1\)</span>的图形：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">quantile</span>(cohort_cox<span class="sc">$</span>PM10_MA_365, <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     25%      50%      75% 
61.18076 69.45975 77.40257 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">quantile</span>(cohort_cox<span class="sc">$</span>PM10_MA_365, <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1%       99% 
 39.12063 105.25648 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>fit_cox_pm10 <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">Surv</span>(t2rehosp, rehosp_staus) <span class="sc">~</span> <span class="fu">ns</span>(PM10_MA_365, <span class="at">knots =</span> <span class="fu">c</span>(<span class="fl">40.48</span>, <span class="dv">80</span>, <span class="dv">90</span>)) <span class="sc">+</span> </span>
<span id="cb35-3"><a href="#cb35-3"></a>    age <span class="sc">+</span> ethnicity <span class="sc">+</span> marriage <span class="sc">+</span> occupation <span class="sc">+</span> <span class="fu">ns</span>(Temperature_MA_07, <span class="at">df =</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fu">ns</span>(RH_MA_07, <span class="at">df =</span> <span class="dv">5</span>),</span>
<span id="cb35-4"><a href="#cb35-4"></a>  <span class="at">data =</span> cohort_cox <span class="sc">%&gt;%</span> </span>
<span id="cb35-5"><a href="#cb35-5"></a>    <span class="fu">filter</span>(PM10_MA_365 <span class="sc">&gt;</span> <span class="dv">40</span> <span class="sc">&amp;</span> PM10_MA_365 <span class="sc">&lt;</span> <span class="dv">105</span>)) </span>
<span id="cb35-6"><a href="#cb35-6"></a></span>
<span id="cb35-7"><a href="#cb35-7"></a>sp_cox_pm10 <span class="ot">=</span> fit_cox_pm10 <span class="sc">%&gt;%</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>  <span class="fu">termplot</span>(<span class="at">se =</span> T, <span class="at">plot =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb35-9"><a href="#cb35-9"></a>  .[[<span class="st">'PM10_MA_365'</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb35-10"><a href="#cb35-10"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-11"><a href="#cb35-11"></a>  .[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">HR =</span> <span class="fu">exp</span>(y),</span>
<span id="cb35-12"><a href="#cb35-12"></a>          <span class="at">HRmin =</span> <span class="fu">exp</span>(y <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>se),</span>
<span id="cb35-13"><a href="#cb35-13"></a>          <span class="at">HRmax =</span> <span class="fu">exp</span>(y <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>se))] <span class="sc">%&gt;%</span> </span>
<span id="cb35-14"><a href="#cb35-14"></a>  .[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">pollutant =</span> <span class="st">'PM10'</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-15"><a href="#cb35-15"></a>  .[]</span>
<span id="cb35-16"><a href="#cb35-16"></a></span>
<span id="cb35-17"><a href="#cb35-17"></a>p_cox_pm10 <span class="ot">=</span> sp_cox_pm10 <span class="sc">%&gt;%</span> </span>
<span id="cb35-18"><a href="#cb35-18"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> HR)) <span class="sc">+</span></span>
<span id="cb35-19"><a href="#cb35-19"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">linetype =</span> <span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb35-20"><a href="#cb35-20"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> HRmin, <span class="at">ymax =</span> HRmax), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> color7[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">color =</span> color7[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb35-22"><a href="#cb35-22"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> pollutant, <span class="at">scales =</span> <span class="st">'free'</span>, <span class="at">labeller =</span> mylabel) <span class="sc">+</span></span>
<span id="cb35-23"><a href="#cb35-23"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb35-24"><a href="#cb35-24"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb35-25"><a href="#cb35-25"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">'Hazard of death'</span>) <span class="sc">+</span></span>
<span id="cb35-26"><a href="#cb35-26"></a>  <span class="fu">theme_test</span>(<span class="at">base_size =</span> <span class="dv">20</span>, <span class="at">base_family =</span> <span class="st">'serif'</span>) <span class="sc">+</span> <span class="co"># , base_family = 'serif'</span></span>
<span id="cb35-27"><a href="#cb35-27"></a>  <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="fl">0.2</span>), <span class="st">'cm'</span>),</span>
<span id="cb35-28"><a href="#cb35-28"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>, <span class="at">face =</span> <span class="st">'bold'</span>),</span>
<span id="cb35-29"><a href="#cb35-29"></a>        <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">alpha</span>(color7[<span class="dv">2</span>], <span class="fl">0.3</span>), <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb35-30"><a href="#cb35-30"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">'bold'</span>))</span>
<span id="cb35-31"><a href="#cb35-31"></a></span>
<span id="cb35-32"><a href="#cb35-32"></a>p_cox_pm10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="5.cohort_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>使用<code>patchwork</code>包进行拼图</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>p_cox_pm2<span class="fl">.5</span><span class="sc">|</span>p_cox_pm10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="5.cohort_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>p_cox_pm2<span class="fl">.5</span><span class="sc">/</span>p_cox_pm10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="5.cohort_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="限制性立方样条" class="level3">
<h3 class="anchored" data-anchor-id="限制性立方样条">限制性立方样条</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>rcs_cox_pm2<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(t2rehosp, rehosp_staus) <span class="sc">~</span> <span class="fu">rcs</span>(PM2<span class="fl">.5</span>_MA_365, <span class="fu">c</span>(<span class="fl">40.48</span>, <span class="dv">60</span>, <span class="dv">63</span>)) <span class="sc">+</span> age <span class="sc">+</span> ethnicity <span class="sc">+</span> marriage <span class="sc">+</span> occupation <span class="sc">+</span> <span class="fu">rcs</span>(Temperature_MA_07, <span class="at">df =</span> <span class="dv">5</span>), </span>
<span id="cb38-2"><a href="#cb38-2"></a>                     <span class="at">data =</span> cohort_cox <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3"></a>    <span class="fu">filter</span>(PM2<span class="fl">.5</span>_MA_365 <span class="sc">&gt;</span> <span class="fl">21.55</span> <span class="sc">&amp;</span> PM2<span class="fl">.5</span>_MA_365 <span class="sc">&lt;</span> <span class="dv">67</span>))</span>
<span id="cb38-4"><a href="#cb38-4"></a></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="fu">anova</span>(rcs_cox_pm2<span class="fl">.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Wald Statistics          Response: Surv(t2rehosp, rehosp_staus) 

 Factor            Chi-Square d.f. P     
 PM2.5_MA_365      26.36       2   &lt;.0001
  Nonlinear         3.44       1   0.0637
 age                0.62       1   0.4327
 ethnicity          0.00       1   0.9448
 marriage           5.03       4   0.2839
 occupation        12.64       5   0.0270
 Temperature_MA_07  4.29       4   0.3682
  Nonlinear         1.92       3   0.5894
 TOTAL NONLINEAR    5.21       4   0.2661
 TOTAL             44.41      17   0.0003</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">datadist</span>(cohort_cox <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="#cb40-2"></a>    <span class="fu">filter</span>(PM2<span class="fl">.5</span>_MA_365 <span class="sc">&gt;</span> <span class="fl">21.55</span> <span class="sc">&amp;</span> PM2<span class="fl">.5</span>_MA_365 <span class="sc">&lt;</span> <span class="dv">67</span>))</span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="fu">options</span>(<span class="at">datadist =</span> <span class="st">'dd'</span>)</span>
<span id="cb40-4"><a href="#cb40-4"></a>HR <span class="ot">&lt;-</span> <span class="fu">Predict</span>(rcs_cox_pm2<span class="fl">.5</span>, PM2<span class="fl">.5</span>_MA_365, <span class="at">fun =</span> exp, <span class="at">ref.zero =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="fu">setDT</span>()</span>
<span id="cb40-6"><a href="#cb40-6"></a>p2 <span class="ot">&lt;-</span> HR <span class="sc">%&gt;%</span> </span>
<span id="cb40-7"><a href="#cb40-7"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PM2<span class="fl">.5</span>_MA_365, <span class="at">y =</span> yhat)) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-10"><a href="#cb40-10"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb40-11"><a href="#cb40-11"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="5.cohort_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="混合线性模型" class="level2">
<h2 class="anchored" data-anchor-id="混合线性模型">混合线性模型</h2>
<section id="读取数据-1" class="level3">
<h3 class="anchored" data-anchor-id="读取数据-1">读取数据</h3>
<div class="cell" data-hash="5.cohort_cache/html/unnamed-chunk-14_5f8d4fda74da9367084e9c25a2f84685">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb41-2"><a href="#cb41-2"></a>  arrow, dplyr, ggplot2, data.table, broom, lme4, splines)</span>
<span id="cb41-3"><a href="#cb41-3"></a></span>
<span id="cb41-4"><a href="#cb41-4"></a>cohort_lme <span class="ot">=</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(</span>
<span id="cb41-5"><a href="#cb41-5"></a>  <span class="st">'Data/cohort_lmer_synthetic.parquet'</span>)</span>
<span id="cb41-6"><a href="#cb41-6"></a></span>
<span id="cb41-7"><a href="#cb41-7"></a><span class="fu">glimpse</span>(cohort_lme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 22,138
Columns: 12
$ id              &lt;int&gt; 1, 1, 2, 2, 3, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, …
$ PM2.5           &lt;dbl&gt; 10.44, 10.44, 10.44, 10.44, 10.92, 10.92, 10.92, 9.69,…
$ body_fat_p      &lt;dbl&gt; 19.4, 21.8, 23.0, 27.3, 22.3, 24.7, 25.9, 34.2, 38.2, …
$ arm_left_fat_p  &lt;dbl&gt; 17.3, 19.3, 22.5, 25.8, 21.5, 22.3, 21.6, 33.2, 36.2, …
$ arm_right_fat_p &lt;dbl&gt; 17.0, 18.6, 19.9, 23.6, 19.7, 19.9, 19.2, 31.3, 34.4, …
$ leg_left_fat_p  &lt;dbl&gt; 17.3, 18.7, 17.1, 21.8, 17.5, 19.6, 22.4, 37.2, 40.6, …
$ leg_right_fat_p &lt;dbl&gt; 17.7, 20.3, 14.3, 20.8, 17.2, 20.7, 22.5, 37.4, 41.1, …
$ trunk_fat_p     &lt;dbl&gt; 20.8, 23.5, 27.5, 31.2, 25.4, 27.8, 28.8, 32.6, 37.2, …
$ age             &lt;dbl&gt; 59, 59, 44, 44, 49, 49, 49, 45, 45, 50, 50, 50, 50, 60…
$ sex             &lt;chr&gt; "Male", "Male", "Male", "Male", "Male", "Male", "Male"…
$ ethnicity       &lt;chr&gt; "White", "White", "White", "White", "White", "White", …
$ smoking_status  &lt;fct&gt; 0. Never, 0. Never, 0. Never, 0. Never, 1. Previous, 1…</code></pre>
</div>
</div>
<div class="cell">

</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2023, 蔡苗</div>   
  </div>
</footer>



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>